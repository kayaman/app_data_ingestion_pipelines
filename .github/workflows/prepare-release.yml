name: Prepare Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'VersÃ£o para release (ex: 1.0.0)'
        required: true
        type: string
      release_type:
        description: 'Tipo de release'
        required: true
        type: choice
        options:
          - minor
          - patch
          - major

jobs:
  prepare:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Generate Changelog
        id: changelog
        uses: mikepenz/release-changelog-builder-action@v5
        with:
          configurationJson: |
            {
              "categories": [
                {
                  "title": "## ðŸš€ Features",
                  "labels": ["feature", "enhancement"]
                },
                {
                  "title": "## ðŸ› Fixes",
                  "labels": ["fix", "bug"]
                },
                {
                  "title": "## ðŸ“š Documentation",
                  "labels": ["documentation", "docs"]
                },
                {
                  "title": "## ðŸ”§ Maintenance",
                  "labels": ["chore", "dependencies"]
                }
              ],
              "template": "#{{CHANGELOG}}\n\n**Full Changelog**: #{{RELEASE_DIFF}}"
            }
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Release Summary
        run: |
          echo "# ðŸ“¦ Release v${{ inputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Changelog" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.changelog.outputs.changelog }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“‹ PrÃ³ximos Passos" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Copie o changelog acima" >> $GITHUB_STEP_SUMMARY
          echo "2. Crie uma branch: \`git checkout -b release/v${{ inputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "3. Atualize o CHANGELOG.md" >> $GITHUB_STEP_SUMMARY
          echo "4. Atualize a versÃ£o nos arquivos necessÃ¡rios" >> $GITHUB_STEP_SUMMARY
          echo "5. Commit: \`git commit -m \"chore(release): prepare v${{ inputs.version }}\"\`" >> $GITHUB_STEP_SUMMARY
          echo "6. Push e abra um PR manualmente" >> $GITHUB_STEP_SUMMARY
          echo "7. ApÃ³s merge, crie a tag: \`git tag v${{ inputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "8. Push da tag: \`git push origin v${{ inputs.version }}\`" >> $GITHUB_STEP_SUMMARY

      - name: Output for Copy
        run: |
          echo "::notice::Changelog gerado com sucesso! Veja o resumo acima."
